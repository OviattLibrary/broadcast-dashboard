<?php
// $Id$
/**
 * @file
 * Broadcast Dashboard module file
 * 
 * This module 'broadcasts' pre-written or custom inserted text to specified areas of a website when switched on.
 */

/**
 * Implements hook_help().
 */

function broadcast_dashboard_help($path, $arg) {
  if ($path === 'admin/help#broadcast_dashboard') {
    return t ('The Broadcast Dashboard module allows for text notifications to be pushed to specified areas of the website when switched on.');
  }
}

/**
 * Implements hook_menu().
 */

function broadcast_dashboard_menu() {
  $items = array();

  $items['admin/config/system/broadcast_dashboard'] = array(
    'title' => 'Broadcast Dashboard',
    'description' => 'Set a message for the Broadcast Dashboard module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('broadcast_dashboard_form'),
    'access_callback' => TRUE,
    'access arguments' => array('administer broadcast dashboard'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/config/system/broadcast_dashboard/settings'] = array(
    'title' => 'Broadcast Dashboard Settings',
    'description' => 'Configuration for the Broadcast Dashboard module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('broadcast_dashboard_settings_form'),
    'access_callback' => TRUE,
    'access arguments' => array('administer broadcast dashboard'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;

}

/**
 * Implements hook_permission().
 */
function broadcast_dashboard_permission() {
  return array(
    'administer broadcast dashboard' => array (
      'title' => t('Administer Broadcast Dashboard'),
      'description' => t('Change configuration for, and send out, Broadcast Dashboard alerts.'),
    ),
  );
}

/**
 * Implements hook_forms().
 */

function broadcast_dashboard_forms($form_id, $args) {

  // if ($form_id == ...)
  /*store_color_values();
  print_r(color_setter(3));
  die();*/

  // Simply reroute the (non-existing) $form_id
  $forms['broadcast_dashboard_form'] = array(
    'callback' => 'broadcast_dashboard_form',
  );

  // Reroute the $form_id and prepend an additional argument that gets passed to
  // the 'mymodule_main_form' form builder function.
  $forms['broadcast_dashboard_settings_form'] = array(
    'callback' => 'broadcast_dashboard_settings_form',
  );

  return $forms;
}

/**
 * Implements hook_form().
 */

function broadcast_dashboard_form($form_state) {  
  $theme_default = variable_get('theme_default', NULL);
  $regions = system_region_list($theme_default, $show = REGIONS_ALL, $labels = TRUE);

  drupal_set_message(t('To edit module configuration, see the <a href="/admin/config/system/broadcast_dashboard/settings">Settings page</a>.'), 'status', FALSE);

  $form['broadcast_dashboard_active'] = array(
    '#type' => "checkbox",
    '#title' => t('Activate Broadcast'),
    '#return_value' => 1,
    '#default_value' => variable_get('broadcast_dashboard_active', 0),
    '#description' => t('When activated, the selected message will be broadcast on the website.'),
  );

  function broadcast_dashboard_get_messages_selector($element) {
  if ($element == "" || is_null($element)) {
    $element = "bd_msg_text";
  }

  //Query DB for Rows
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id', 'bd_msg_title', 'bd_msg_text',));
  $query->orderBy('bd_id', 'ASC');
  $results = $query->execute();

  //define rows
  $title_options = array();

  //test if the results array has any values
  $custom_val = "custom_msg";
  if (is_array($results) || is_object($results)) {
    foreach ($results as $result) {
      $title_options[$result->$element] = $result->bd_msg_title;
    }
    $title_options[$custom_val] = "Custom";
  }
  return $title_options;
}

 // Custom message selector
  $form['broadcast_dashboard_message'] = array(
    '#type' => 'select',
    '#title' => t('Messages'),
    '#default_value' => NULL,
    '#options' => broadcast_dashboard_get_messages_selector("bd_msg_text"),
    '#description' => t('Select a custom message to edit.'),
    '#required' => FALSE,
    '#states' => array(
    "visible" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
      "required" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
    ),
  );

  // Old message selector
  /*$form['broadcast_dashboard_message'] = array(
    '#type' => 'select',
    '#title' => t('Type of Message'),
    '#default_value' => variable_get('broadcast_dashboard_message', 0),
    '#options' => array(
      1 => t('Drill'),
      2 => t('Earthquake'),
      3 => t('Fire'),
      4 => t('Shooter'),
      5 => t('Custom'),
    ),
    '#description' => t('Select the type of message to broadcast.'),
    '#required' => FALSE,
    '#states' => array(
    "visible" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
      "required" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
    ),
  );*/

  $form['broadcast_dashboard_region'] = array(
    '#type' => 'select',
    '#title' => t('Region Selection'),
    '#default_value' => variable_get('broadcast_dashboard_region', 0),
    '#options' => $regions,
    '#description' => t('Select a location to display the message.'),
    '#required' => FALSE,
    '#states' => array(
    "visible" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
      "required" => array(
      "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
    ),
  );

  $form['broadcast_dashboard_custom_message'] = array (
    '#type' => 'textarea',
    '#default_value' => variable_get('broadcast_dashboard_custom_message', 'Broadcast Dashboard Custom Message'),
    '#title' => t('Broadcast Dashboard Custom Message'),
    '#description' => t('Custom message to appear in place of pre-written notification text.'),
    '#size' => 60,
    '#maxlength' => 255,
    '#states' => array(
      "visible" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE),
        ":input[name='broadcast_dashboard_message']" => array("value" => 'custom_msg')),
      "required" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE),
        ":input[name='broadcast_dashboard_message']" => array("value" => 'custom_msg')),
    ),
  );

  $form['broadcast_dashboard_custom_message_color'] = array(
    '#type' => 'select',
    '#title' => t('Color of Message'),
    '#default_value' => variable_get('broadcast_dashboard_custom_message_color', 0),
    '#options' => array(
      1 => t('Success - Green'),
      2 => t('Info - Blue'),
      3 => t('Warning - Yellow'),
      4 => t('Danger - Red'),
    ),
    '#description' => t('Set the custom message color based on Bootstrap alerts.'),
    '#required' => FALSE,
    '#states' => array(
      "visible" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE),
        ":input[name='broadcast_dashboard_message']" => array("value" => 'custom_msg')),
      "required" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE),
        ":input[name='broadcast_dashboard_message']" => array("value" => 'custom_msg')),
    ),
  );

  // Dynamically pre-insert values of pre-written messages into page

  // Get number of rows
  $result = db_select('broadcast_dashboard', 'bd_id')
            ->fields('bd_id')
            ->execute();
  $num_of_rows = $result->rowCount();

  /*** COLOR CLASS ***/

  //Query DB for Rows
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id', 'bd_clr_class'));
  $query->orderBy('bd_id', 'ASC');
  $query->condition('bd_clr_hex', '');
  $results = $query->execute();

  //define rows
  $clr_class_list = array();

  //test if the results array has any values
  if (is_array($results) || is_object($results)) {
    foreach ($results as $result) {
      $clr_class_list[$result->bd_id] = $result->bd_clr_class;
    }
  }

  echo "<pre>";
  print_r($clr_class_list);
  echo "</pre>";

  /*** HEX COLOR ***/

  //Query DB for Rows
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id', 'bd_clr_hex'));
  $query->orderBy('bd_id', 'ASC');
  $query->condition('bd_clr_class', '');
  $results = $query->execute();

  //define rows
  $clr_hex_list = array();

  //test if the results array has any values
  if (is_array($results) || is_object($results)) {
    foreach ($results as $result) {
      $clr_hex_list[$result->bd_id] = $result->bd_clr_hex;
    }
  }

  echo "<pre>";
  print_r($clr_hex_list);
  echo "</pre>";

  /*** GET IDS FOR LOOP ***/

  //Query DB for Rows
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id'));
  $query->orderBy('bd_id', 'ASC');
  $results = $query->execute();

  //define rows
  $id_list = array();

  // Get loopy stuff
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id', 'bd_clr_class', 'bd_clr_hex'));
  $query->orderBy('bd_id', 'ASC');
  $results = $query->execute();

  while ($row = $results->fetch(PDO::FETCH_BOTH)) {
    //printf("ID: %s  class_name: %s  class_hex: %s", $row["bd_id"], $row["bd_clr_class"], $row["bd_clr_hex"]);

    if (!empty($row["bd_clr_class"])) {
      $form['broadcast_dashboard_clr_class_' . $row["bd_id"]] = array(
        '#type' => 'hidden',
        '#title' => t('Message Color Class'),
        '#default_value' => $row["bd_clr_class"],
        '#description' => t('The color class of the selected pre-written message ID' . $row["bd_id"]),
        '#required' => FALSE,
      );
    }
  }

  $form['broadcast_dashboard_clr_class'] = array(
    '#type' => 'hidden',
    '#title' => t('Message Color Class'),
    '#default_value' => null,
    '#description' => t('The color class of the selected pre-written message.'),
    '#required' => FALSE,
  );

  $form['broadcast_dashboard_clr_hex'] = array(
    '#type' => 'hidden',
    '#title' => t('Message Color Hex'),
    '#default_value' => null,
    '#description' => t('The color hex of the selected pre-written message.'),
    '#required' => FALSE,
  );

  $form['broadcast_dashboard_date_message_posted'] = array(
    '#type' => 'hidden',
    '#title' => t('Date Message Posted'),
    '#default_value' => null,
    '#description' => t('The date and time the message was posted.'),
    '#required' => FALSE,
  );

  // Include Preview Javascript file
  /*$form['#attached']['js'] = array(
    drupal_get_path('module', 'broadcast_dashboard') . '/broadcast_dashboard_preview.js',
  );*/

  // Preview button
  $form['preview'] = array(
    '#type' => 'button',
    '#value' => t('Preview'),
    '#executes_submit_callback' => FALSE,
    '#attributes' => array('onclick' => "return (false);"),//array('onclick' => "runPreview('".$test_var."'); return (false);"),
    '#states' => array(
      "visible" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
      "required" => array(
        "input[name='broadcast_dashboard_active']" => array("checked" => TRUE)),
    ),
  );

  // Submit button
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save settings'),
  );

  // Preview area
  $form['preview_area'] = array(
    '#type' => 'markup',
    '#markup' => t('<div id="markuparea"></div>'),
  );

  return $form;
}

/**
 * Implements hook_form_submit().
 */

function broadcast_dashboard_form_submit($form, &$form_state) {
  $form_has_errors = FALSE;

  // Active Check
  $current_active = $form_state['values']['broadcast_dashboard_active'];
  $previous_active = variable_get('broadcast_dashboard_active');
  $set_active = $form_state['values']['broadcast_dashboard_active'];
  variable_set('broadcast_dashboard_active', $set_active);

  // Type of Message Check
  $current_msg_type = $form_state['values']['broadcast_dashboard_message'];
  $previous_msg_type = variable_get('broadcast_dashboard_message');
  $set_msg_type = $form_state['values']['broadcast_dashboard_message'];
  variable_set('broadcast_dashboard_message', $set_msg_type);

  // Region Check
  $current_region = $form_state['values']['broadcast_dashboard_region'];
  $previous_region = variable_get('broadcast_dashboard_region');
  $set_region = $form_state['values']['broadcast_dashboard_region'];
  variable_set('broadcast_dashboard_region', $set_region);
  
  // Custom Message Check
  if (!empty($form_state['values']['broadcast_dashboard_custom_message'])) {
    $current_title = $form_state['values']['broadcast_dashboard_custom_message'];
    $previous_title = variable_get('broadcast_dashboard_custom_message');
      // prevents check_plain from double encoding a pre-existing string
      if ($current_title != $previous_title) {
        $set_title = check_plain($form_state['values']['broadcast_dashboard_custom_message']);
        variable_set('broadcast_dashboard_custom_message',
                   $set_title);
      }
  }

  // Custom Message Color Check
  $current_color = $form_state['values']['broadcast_dashboard_custom_message_color'];
  $previous_color = variable_get('broadcast_dashboard_custom_message_color');
  $set_color = $form_state['values']['broadcast_dashboard_custom_message_color'];
  variable_set('broadcast_dashboard_custom_message_color', $set_color);

  // Set date and time message posted
  variable_set('broadcast_dashboard_date_message_posted', date("m/d/Y h:i:sa"));

  if ($form_has_errors == FALSE) {
    drupal_set_message(t('The settings have successfully been saved.'));
  }
}

/**
 * Custom function for testing output.
 *
 * @param bool $active
 *   A boolean that indicates whether Broadcast message should be displayed or not.
 *
 * @param array $msg_type
 *   Array of type of message - includes custom message option.
 *
 * @param string $region
 *   String containing region name to be passed to alter function.
 *
 * @param string $cust_msg
 *   String containing custom Broadcast message.
 *
 * @param string $cust_msg_clr
 *   String containing semantic color for message box.
 *
 */

function broadcast_dashboard_test_display() {                  

  global $theme_key; 
  print 'Our current theme is: ' . $theme_key . '<br>';

  $regions = system_region_list($theme_key, $show = REGIONS_ALL, $labels = FALSE);
  print '<pre>';
  print_r($regions);
  print '</pre>';

  $active = variable_get('broadcast_dashboard_active'); 

  print 'Active state is: ' . $active; print "<br>";
  
  if ($active == 1) {
    $msg_type = variable_get('broadcast_dashboard_message');  
    $region = variable_get('broadcast_dashboard_region');
    $cust_msg = variable_get('broadcast_dashboard_custom_message');
    $cust_msg_clr = variable_get('broadcast_dashboard_custom_message_color');

    print 'Message type is: '. $msg_type; print "<br>";
    print 'Target region is: '. $region; print "<br>";
    print 'Custom message is: '. $cust_msg; print "<br>";
    print 'Custom message color is: '. $cust_msg_clr;
  }

  print '<br>';
  $msg_date = date("m/d/Y h:i:sa");
  print $msg_date;

}

/**
 * Function to store all color elements in an array in page load for Javascript to later have access to.
 */
function store_color_values() {
  /*$colors = array();

  $result = db_query('SELECT bd_id, bd_clr_class, bd_clr_hex FROM broadcast_dashboard')->fetchAssoc();

  echo '<pre>';
  print_r($result);
  echo '</pre>';

  foreach ($result as $item) {

  }*/

}

/**
 * Global function to set alert color classes in page_build()
 */
function color_setter($message_id) {

  $result = db_query('SELECT bd_id, bd_clr_class, bd_clr_hex FROM broadcast_dashboard WHERE bd_id = :message_id', array(':message_id' => $message_id))->fetchAssoc(); 

  $clr_class = $result[bd_clr_class];
  $clr_hex = $result[bd_clr_hex];

  if (empty($clr_hex)) {
    return t($clr_class);
  } else if (empty($clr_class)) {
    return t($clr_hex);
  } else {
    return t($clr_class);
  }

  //drupal_set_message(t('The output for result is: @var', array('@var' => $value)), 'status');

  //return t($value);
}


/**
 * Implements hook_page_build().
 */

function broadcast_dashboard_page_build(&$page) {

//  print '<pre>';
//  print_r($page);
//  print '<pre>';

//  dpm($page);

  $active = variable_get('broadcast_dashboard_active');
  $msg_type = variable_get('broadcast_dashboard_message');
  $preset_msg = null;
  $preset_clr = null;
  $region = variable_get('broadcast_dashboard_region');
  $cust_msg = variable_get('broadcast_dashboard_custom_message');
  $cust_msg_clr = variable_get('broadcast_dashboard_custom_message_color');
  $clr_code = null;
  $msg_date = variable_get('broadcast_dashboard_date_message_posted');

  // DEV - test notification
  $page[$region]['main']['#markup'] = '<div class="alert alert-info" role="alert">This system is currently being tested. Ignore any alerts.' . $page[$region]['main']['#markup'] . '</div>';

  if (!empty($msg_type)) {
    // Pre-set messages
    if ($msg_type == 1) {
      // Drill
      $preset_msg = "There is currently a drill taking place. Please remain calm.";
      $preset_clr = 2;
    } elseif ($msg_type == 2) {
      // Earthquake
      $preset_msg = "There is currently an earthquake. Drop, cover, and hold.";
      $preset_clr = 3;
    } elseif ($msg_type == 3) {
      // Fire
      $preset_msg = "A fire has been reported. Please calmly evacuate the building.";
      $preset_clr = 4;
    } elseif ($msg_type == 4) {
      // Shooter
      $preset_msg = "An active shooter has been reported. Take cover and, if possible, escape through a window or door.";
      $preset_clr = 4;
    } elseif ($msg_type == 5) {
      // Custom

    }
  }

  // No custom, push preset message
  if (($active == 1) && ($msg_type != 5)) {
    $clr_code = color_setter($preset_clr);
    
    if (!empty($clr_code) && !empty($preset_msg)) {
      $page[$region]['system_main']['#markup'] = '<div class="'. $clr_code .'" role="alert">' . $preset_msg . ' (Posted on: ' . $msg_date . ')' . $page[$region]['system_main']['#markup'] . '</div>';
    }
  } else if ($msg_type == 5) { // end no custom msg
    // For custom alerts
    // Set alert color based on setting
    $clr_code = color_setter($cust_msg_clr);
    
    if (!empty($clr_code) && !empty($cust_msg)) {
      $page[$region]['system_main']['#markup'] = '<div class="'. $clr_code .'" role="alert">' . $cust_msg . ' (Posted on: ' . $msg_date . ')' . $page[$region]['system_main']['#markup'] . '</div>';
    }
  } // end custom msg

}

/**
 * Code beyond this point is for the Settings page.
 */

/**
 * Implements hook_form().
 */

function broadcast_dashboard_get_messages($element) {
  if ($element == "" || is_null($element)) {
    $element = "bd_msg_text";
  }

  //Query DB for Rows
  $query = db_select('broadcast_dashboard');
  $query->fields('broadcast_dashboard', array('bd_id', 'bd_msg_title', 'bd_msg_text'));
  $query->orderBy('bd_id', 'ASC');
  $results = $query->execute();

  //define rows
  $title_options = array();

  //test if the results array has any values
  if (is_array($results) || is_object($results)) {
    foreach ($results as $result) {
      $title_options[$result->$element] = $result->bd_msg_title;
    }
  }

  return $title_options;
}

/**
 * Checks if the table has rows/elements.
 *
 * @return TRUE if rows exist
 * @return FALSE if no rows exist
 */
function broadcast_dashboard_has_rows() {
  // Get the number of rows in the table
  $result = db_select('broadcast_dashboard', 'bd_id')
            ->fields('bd_id')
            ->execute();
  $num_of_rows = $result->rowCount();

  if ($num_of_rows == 0) {
    return FALSE;
  } else {
    return TRUE;
  }
}

function broadcast_dashboard_settings_form($form_state) {

  /*echo "<pre>";
  print_r(broadcast_dashboard_get_messages("bd_msg_text"));
  echo "</pre>";

  die();*/

  $theme_default = variable_get('theme_default', NULL);
  $regions = system_region_list($theme_default, $show = REGIONS_ALL, $labels = TRUE);

  $default_title = t('Select a message');

  if (broadcast_dashboard_has_rows()) {

    // START Update Message Block
    $form['broadcast_dashboard_settings_update_msg'] = array(
      '#type' => 'fieldset',
      '#title' => t('Update Existing Message'),
      '#description' => t('Update an existing pre-written Broadcast Dashboard message.'),
      '#collapsible' => FALSE,
    );

    // Header
    // Hiding header becasue fieldset has a title. @TODO: accessiblility -- do we need an <h2> for clarity?
    /*$form['broadcast_dashboard_settings_update_msg']['broadcast_dashboard_settings_update_msg_header'] = array(
      '#type' => 'markup',
      '#markup' => t('<h2>Custom Messages</h2>'),
    );*/

    $form['broadcast_dashboard_settings_update_msg']['broadcast_dashboard_settings_update_msg_custom_message_select'] = array(
      '#type' => 'select',
      '#title' => t('Messages'),
      '#default_value' => $default_title,
      '#options' => broadcast_dashboard_get_messages("bd_msg_text"),
      '#description' => t('Select a custom message to delete.'),
      '#required' => FALSE,
      /*'#states' => array(
        'visible' => array(
          ':input[name="data_set"]' => array('value' => 'broadcast_dashboard'),
        ),
      ),*/
    );

    // Include value grab Javascript file
    $form['#attached']['js'] = array(
      drupal_get_path('module', 'broadcast_dashboard') . '/broadcast_dashboard_value_grab.js',
    );

    // Custom message editor
    $form['broadcast_dashboard_settings_update_msg']['broadcast_dashboard_settings_update_msg_custom_message_edit'] = array(
      '#type' => 'textarea',
      '#title' => t('Message Text'),
      //'#default_value' => broadcast_dashboard_get_message_text($arg),
      '#default_value' => NULL,
      '#description' => t('The text that will be displayed when the selected message is turned on.'),
      '#required' => TRUE,
    );

    // Submit button
    $form['broadcast_dashboard_settings_update_msg']['update_existing_message_submit'] = array(
      '#name' => 'submit_update_msg',
      '#type' => 'submit',
      '#value' => t('Update message'),
      '#submit' => array('broadcast_dashboard_settings_edit'),
    );

    // END Update Message Block

    // START Delete Message Block

    // Include confirmation popup content
    $form['#attached']['js'][] = drupal_get_path('module', 'broadcast_dashboard') . '/broadcast_dashboard_confirm_delete.js';
    $form['#attached']['css'][] = drupal_get_path('module', 'broadcast_dashboard') . '/broadcast_dashboard_confirm_delete.css';

    $form['broadcast_dashboard_settings_delete_msg'] = array(
      '#type' => 'fieldset',
      '#title' => t('Delete Existing Message'),
      '#description' => t('Delete an existing pre-written Broadcast Dashboard message.'),
      '#collapsible' => FALSE,
    );

    // Header
    // Hiding header becasue fieldset has a title. @TODO: accessiblility -- do we need an <h2> for clarity?
    /*$form['broadcast_dashboard_settings_update_msg']['broadcast_dashboard_settings_update_msg_header'] = array(
      '#type' => 'markup',
      '#markup' => t('<h2>Delete Messages</h2>'),
    );*/

    // Custom message selector
    $form['broadcast_dashboard_settings_delete_msg']['broadcast_dashboard_settings_delete_msg_custom_message_select'] = array(
      '#type' => 'select',
      '#title' => t('Messages'),
      '#default_value' => $default_title,
      '#options' => broadcast_dashboard_get_messages("bd_id"),
      '#description' => t('Select a custom message to delete.'),
      '#required' => FALSE,
      /*'#states' => array(
        'visible' => array(
          ':input[name="data_set"]' => array('value' => 'broadcast_dashboard'),
        ),
      ),*/
    );

    // Submit button
    $form['broadcast_dashboard_settings_delete_msg']['delete_existing_message_submit'] = array(
      '#name' => 'submit_delete_message',
      '#type' => 'submit',
      '#value' => t('Delete message'),
      '#submit' => array('broadcast_dashboard_settings_delete'),
    );

    // @TODO: Confirmation pop-up (hook confirm_form())

    // END Delete Message Block

  } else {
    drupal_set_message(t('Add a pre-written message to unlock editing and deleting.'), 'warning');
  } // end has_rows() check

  // START Add Message Block

  $form['broadcast_dashboard_settings_add_msg'] = array(
    '#type' => 'fieldset',
    '#title' => t('Add Message'),
    '#description' => t('Add a new pre-written Broadcast Dashboard message.'),
    '#collapsible' => FALSE,
  );

  // Custom message add
  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_msg_name_message'] = array(
    '#type' => 'textfield',
    '#title' => t('Message Name'),
    //'#default_value' => broadcast_dashboard_get_message_text($arg),
    '#default_value' => NULL,
    '#description' => t('How this message will be identified in the backend.'),
    '#required' => FALSE,
    '#states' => array(
      'required' => array(
        ":input[name='broadcast_dashboard_settings_add_msg_custom_message']" => array('filled' => TRUE),
      ),
      array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array('filled' => TRUE),
      ),
      array(
        ":input[name='broadcast_dashboard_settings_add_msg_name_message']" => array('filled' => TRUE),
      ),
    ),
  );

  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_msg_custom_message'] = array(
    '#type' => 'textarea',
    '#title' => t('Message Text'),
    //'#default_value' => broadcast_dashboard_get_message_text($arg),
    '#default_value' => NULL,
    '#description' => t('The text that will be displayed when the selected message is turned on.'),
    '#required' => FALSE,
    '#states' => array(
      'required' => array(
        ":input[name='broadcast_dashboard_settings_add_msg_name_message']" => array('filled' => TRUE),
      ),
      array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array('filled' => TRUE),
      ),
      array(
        ":input[name='broadcast_dashboard_settings_add_msg_custom_message']" => array('filled' => TRUE),
      ),
    ),
  );

  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_color'] = array(
    '#type' => 'radios',
    '#title' => t('Message Color'),
    '#options' => array(
      'class' => t('CSS Class'),
      'hex' => t('Hex Code'),
    ),
    '#description' => t('Select how to set the message\'s background color.'),
    '#required' => FALSE,
    '#default_value' => 'class',
    '#states' => array(
      'required' => array(
        ":input[name='broadcast_dashboard_settings_add_msg_name_message']" => array('filled' => TRUE),
      ),
      array(
        ":input[name='broadcast_dashboard_settings_add_msg_custom_message']" => array('filled' => TRUE),
      ),
    ),
  );

  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_css_class'] = array(
    '#type' => 'textfield',
    '#title' => t('CSS Class'),
    '#default_value' => NULL,
    '#description' => t('Classes that will be added to this message\'s display.'),
    '#required' => FALSE,
    '#states' => array(
      "visible" => array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array("value" => 'class')),
      "required" => array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array("value" => 'class')),
    ),
  );

  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_hex_code'] = array(
    '#type' => 'textfield',
    '#title' => t('Hex Code'),
    '#default_value' => NULL,
    '#description' => t('Color hex code that will be added to this message\'s display. Example: #ffffff'),
    '#required' => FALSE,
    '#states' => array(
      "visible" => array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array("value" => 'hex')),
      "required" => array(
        ":input[name='broadcast_dashboard_settings_add_color']" => array("value" => 'hex')),
    ),
  );

  // Preview button
  $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_preview'] = array(
    '#type' => 'button',
    '#value' => t('Preview'),
    '#executes_submit_callback' => FALSE,
    '#attributes' => array('onclick' => "return (false);"),//array('onclick' => "runPreview('".$test_var."'); return (false);"),
  );

  // Submit button
    $form['broadcast_dashboard_settings_add_msg']['broadcast_dashboard_settings_add_submit'] = array(
      '#name' => 'submit_add_message',
      '#type' => 'submit',
      '#value' => t('Update message'),
      '#submit' => array('broadcast_dashboard_settings_add'),
    );

  // END Add Message Block

  // Preview area
  $form['broadcast_dashboard_settings_add_msg']['preview_area'] = array(
    '#type' => 'markup',
    '#markup' => t('<div id="markuparea"></div>'),
  );

  return $form;
}

/**
 * Form submission functions.
 *
 * Does not extend hook_form_submit().
 */

/**
 * For the edited of a current message form.
 */
function broadcast_dashboard_settings_edit($form, &$form_state) {
  $form_has_errors = FALSE;

  // Check if message text is blank
  if (!empty($form_state['values']['broadcast_dashboard_settings_update_msg_custom_message_edit'])) {
    $current_title = $form['broadcast_dashboard_settings_update_msg']['broadcast_dashboard_settings_update_msg_custom_message_select']['#options'][$form_state['values']['broadcast_dashboard_settings_update_msg_custom_message_select']];
    $current_msg = $form_state['values']['broadcast_dashboard_settings_update_msg_custom_message_edit'];

    // Update query
    $query = db_update('broadcast_dashboard');
    $query->condition('bd_msg_title',$current_title);
    $query->fields(
      array(
        'bd_msg_text' => $current_msg,
      )
    );
    $results = $query->execute();
  }

  if ($form_has_errors == FALSE) {
    drupal_set_message(t('The settings have successfully been saved.'));
  }
}

/**
 * For the deletion of a current message form.
 */
function broadcast_dashboard_settings_delete($form, &$form_state) {
  $form_has_errors = FALSE;

  $delete_row = $form_state['values']['broadcast_dashboard_settings_delete_msg_custom_message_select'];

  // Get the number of rows in the table
  $result = db_select('broadcast_dashboard', 'bd_id')
            ->fields('bd_id')
            ->execute();
  $num_of_rows = $result->rowCount();

  if ($delete_row <= $num_of_rows) {
    echo "Delete row: " + $delete_row;
    echo "Num rows: " + $num_of_rows;
    echo "Would be deleted.";
  }

  // Delete query
  $query = db_delete('broadcast_dashboard')
    ->condition('bd_id', $delete_row)
    ->execute();

  if ($form_has_errors == FALSE) {
    drupal_set_message(t('The selected message was deleted successfully.'));
  }
}

/**
 * For the addition of a current message form.
 */
function broadcast_dashboard_settings_add($form, &$form_state) {
  $form_has_errors = FALSE;

  $add_name = $form_state['values']['broadcast_dashboard_settings_add_msg_name_message'];
  $add_msg = $form_state['values']['broadcast_dashboard_settings_add_msg_custom_message'];
  $add_class = $form_state['values']['broadcast_dashboard_settings_add_css_class'];
  $add_hex = $form_state['values']['broadcast_dashboard_settings_add_hex_code'];

  if (empty($add_name)) echo "add name empty<br>";
  if (empty($add_msg)) echo "add msg empty<br>";
  if (empty($add_class)) echo "add class empty<br>";
  if (empty($add_hex)) echo "add hex empty<br>";

  //die();

  // Hex check for string
  if (!empty($add_hex)) {
    $firstCharacter = substr($add_hex, 0, 1);

    echo "Hex input: " . $add_hex . "\n";
    echo "First char: " . $firstCharacter . "\n";

    if ($firstCharacter != "#") {
      $add_hex = "#" . $add_hex;
    }

    echo "New hex: " . $add_hex;
  }

  if (!empty($add_name) && !empty($add_msg) && (!empty($add_class) || !empty($add_hex)) ) {
    // Fields are fine
    $result = db_insert('broadcast_dashboard')
      ->fields(
        array(
          //'bd_id' => auto increments
          'bd_msg_title' => $add_name,
          'bd_msg_text' => $add_msg,
          'bd_clr_class' => $add_class,
          'bd_clr_hex' => $add_hex,
        )
      )->execute();
  } else {
    // Form has errors
    $form_has_errors = TRUE;
  }

  if ($form_has_errors == FALSE) {
    drupal_set_message(t('The message was added successfully.'));
  }

  if ($form_has_errors == TRUE) {
    drupal_set_message(t('The message was not successfully added. Make sure that all required fields are completed and try again.'),'error');
  }

}

/**
 * Debug function for testing
 */
function debug_to_console( $data ) {
    $output = $data;
    if ( is_array( $output ) )
        $output = implode( ',', $output);
    echo "<script>console.log( 'Debug Objects: " . $output . "' );</script>";
}